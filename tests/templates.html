<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste do Sistema de Templates</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 30px;
        }
        
        .test-section {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .test-section h2 {
            color: #2d3748;
            border-bottom: 2px solid #4299e1;
            padding-bottom: 10px;
        }
        
        button {
            background: linear-gradient(45deg, #4299e1, #667eea);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(66, 153, 225, 0.4);
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .success {
            background: #c6f6d5;
            border: 1px solid #68d391;
            color: #22543d;
        }
        
        .error {
            background: #fed7d7;
            border: 1px solid #fc8181;
            color: #742a2a;
        }
        
        .info {
            background: #bee3f8;
            border: 1px solid #63b3ed;
            color: #2a4365;
        }
        
        code {
            background: #e2e8f0;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste do Sistema de Templates DOCX</h1>
        
        <div class="test-section">
            <h2>üìã 1. Verifica√ß√£o de Depend√™ncias</h2>
            <button onclick="testarDependencias()">Testar Bibliotecas</button>
            <div id="status-deps"></div>
        </div>
        
        <div class="test-section">
            <h2>üìÑ 2. Gerar Template Exemplo</h2>
            <p>Clique para baixar um template de exemplo com todos os placeholders:</p>
            <button onclick="gerarTemplateExemplo()">Baixar Template Exemplo</button>
            <div id="status-template"></div>
        </div>
        
        <div class="test-section">
            <h2>üîç 3. Ver Placeholders Dispon√≠veis</h2>
            <p>Lista completa de placeholders que podem ser usados nos templates:</p>
            <button onclick="mostrarPlaceholders()">Ver Lista de Placeholders</button>
            <div id="status-placeholders"></div>
        </div>
        
        <div class="test-section">
            <h2>üìù 4. Teste de Mapeamento</h2>
            <p>Simula o preenchimento de um template com dados de exemplo:</p>
            <button onclick="testarMapeamento()">Simular Preenchimento</button>
            <div id="status-mapping"></div>
        </div>
        
        <div class="test-section">
            <h2>üíæ 5. Sistema Principal</h2>
            <p>Link para o sistema principal:</p>
            <button onclick="window.open('index.html', '_blank')">Abrir Sistema Principal</button>
        </div>
    </div>

    <!-- Carregar bibliotecas necess√°rias -->
    <script src="https://unpkg.com/docx@7.8.2/build/index.js"></script>
    <script src="../src/core/utils.js"></script>
    <script src="../src/core/calculations.js"></script>
    <script src="../src/core/exports.js"></script>
    
    <script>
        // Dados de exemplo para testes
        const DADOS_EXEMPLO = {
            'CONTRATO': '2024001',
            'DATA': '15/01/2024',
            'NOME COMPLETO': 'Jo√£o Silva Santos',
            'N√öMERO DO CPF': '123.456.789-00',
            'RG RESPONSAVEL': '12.345.678-9',
            'TELEFONE': '(11) 99999-9999',
            'ENDERE√áO COMPLETO': 'Rua das Flores, 123',
            'BAIRRO': 'Centro',
            'CEP': '01234-567',
            'CID/EST': 'S√£o Paulo/SP',
            'NOME DO ALUNO': 'Maria Silva Santos',
            'CPF DO ALUNO': '987.654.321-00',
            'RG ALUNO': '98.765.432-1',
            'PROFISSIONALIZANTE': 'T√©cnico em Inform√°tica',
            'CARGA HOR√ÅRIA': '800 horas',
            'VALOR TOTAL': 'R$ 2.400,00'
        };

        function log(id, message, type = 'info') {
            const element = document.getElementById(id);
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            element.innerHTML = `<div class="${className}">${message}</div>`;
        }

        function testarDependencias() {
            log('status-deps', 'üîÑ Verificando bibliotecas...', 'info');
            
            setTimeout(() => {
                const tests = [
                    { name: 'docx', check: () => window.docx?.Document },
                    { name: 'PLACEHOLDERS_CANONICOS', check: () => window.PLACEHOLDERS_CANONICOS },
                    { name: 'titleCase', check: () => window.titleCase },
                    { name: 'maskCPF', check: () => window.maskCPF },
                    { name: 'ContractCalculations', check: () => window.ContractCalculations },
                    { name: 'ContractExports', check: () => window.ContractExports }
                ];
                
                const results = tests.map(test => ({
                    name: test.name,
                    loaded: !!test.check()
                }));
                
                const allLoaded = results.every(r => r.loaded);
                const missing = results.filter(r => !r.loaded);
                
                let message = `
                    <strong>Resultado das Depend√™ncias:</strong><br>
                    ${results.map(r => `${r.loaded ? '‚úÖ' : '‚ùå'} ${r.name}`).join('<br>')}
                    <br><br>
                `;
                
                if (allLoaded) {
                    message += '<strong>Status:</strong> ‚úÖ Todas as depend√™ncias carregadas!';
                } else {
                    message += `<strong>Status:</strong> ‚ùå ${missing.length} bibliotecas faltando<br>`;
                    message += `<strong>Faltando:</strong> ${missing.map(m => m.name).join(', ')}`;
                }
                
                // Teste espec√≠fico do docx
                if (window.docx) {
                    try {
                        const { Document, Paragraph, TextRun } = window.docx;
                        if (Document && Paragraph && TextRun) {
                            message += '<br><br>‚úÖ Biblioteca docx funcionando corretamente';
                        }
                    } catch (error) {
                        message += '<br><br>‚ùå Erro na biblioteca docx: ' + error.message;
                    }
                }
                
                log('status-deps', message, allLoaded ? 'success' : 'error');
            }, 1000);
        }

        async function gerarTemplateExemplo() {
            log('status-template', 'üîÑ Gerando template exemplo...', 'info');
            
            try {
                if (!window.docx?.Document) {
                    throw new Error('Biblioteca docx n√£o carregada');
                }
                
                const { Document, Paragraph, TextRun, HeadingLevel, AlignmentType } = window.docx;
                
                const doc = new Document({
                    sections: [{
                        properties: {},
                        children: [
                            new Paragraph({
                                children: [new TextRun({
                                    text: "CONTRATO DE PRESTA√á√ÉO DE SERVI√áOS - EXEMPLO",
                                    bold: true,
                                    size: 32
                                })],
                                heading: HeadingLevel.TITLE,
                                alignment: AlignmentType.CENTER
                            }),
                            
                            new Paragraph({ text: "" }),
                            
                            new Paragraph({
                                children: [
                                    new TextRun({ text: "Contrato: ", bold: true }),
                                    new TextRun({ text: "{{CONTRATO}}" }),
                                    new TextRun({ text: " | Data: ", bold: true }),
                                    new TextRun({ text: "{{DATA}}" })
                                ]
                            }),
                            
                            new Paragraph({ text: "" }),
                            
                            new Paragraph({
                                children: [new TextRun({ text: "RESPONS√ÅVEL FINANCEIRO", bold: true })]
                            }),
                            
                            new Paragraph({
                                children: [
                                    new TextRun({ text: "Nome: {{NOME COMPLETO}}" }),
                                    new TextRun({ text: " | CPF: {{N√öMERO DO CPF}}" })
                                ]
                            }),
                            
                            new Paragraph({
                                children: [new TextRun({ text: "Telefone: {{TELEFONE}}" })]
                            }),
                            
                            new Paragraph({ text: "" }),
                            
                            new Paragraph({
                                children: [new TextRun({ text: "DADOS DO ALUNO", bold: true })]
                            }),
                            
                            new Paragraph({
                                children: [new TextRun({ text: "Nome: {{NOME DO ALUNO}} | CPF: {{CPF DO ALUNO}}" })]
                            }),
                            
                            new Paragraph({ text: "" }),
                            
                            new Paragraph({
                                children: [new TextRun({ text: "CURSO E VALORES", bold: true })]
                            }),
                            
                            new Paragraph({
                                children: [new TextRun({ text: "Curso: {{PROFISSIONALIZANTE}}" })]
                            }),
                            
                            new Paragraph({
                                children: [new TextRun({ text: "Valor Total: {{VALOR TOTAL}}" })]
                            })
                        ]
                    }]
                });
                
                const buffer = await window.docx.Packer.toBlob(doc);
                const url = URL.createObjectURL(buffer);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = 'Template_Teste_Exemplo.docx';
                a.click();
                
                URL.revokeObjectURL(url);
                
                log('status-template', '‚úÖ Template exemplo baixado com sucesso!<br>Arquivo: <code>Template_Teste_Exemplo.docx</code>', 'success');
                
            } catch (error) {
                console.error('Erro:', error);
                log('status-template', `‚ùå Erro ao gerar template: ${error.message}`, 'error');
            }
        }

        function mostrarPlaceholders() {
            log('status-placeholders', 'üîÑ Gerando lista de placeholders...', 'info');
            
            // Lista padr√£o de placeholders se PLACEHOLDERS_CANONICOS n√£o estiver dispon√≠vel
            let placeholders = [];
            
            if (window.PLACEHOLDERS_CANONICOS) {
                placeholders = Object.keys(PLACEHOLDERS_CANONICOS).sort();
                log('status-placeholders', '‚úÖ Usando PLACEHOLDERS_CANONICOS do sistema', 'info');
            } else {
                // Lista manual dos placeholders principais
                placeholders = [
                    'CONTRATO', 'DATA', 'NOME COMPLETO', 'N√öMERO DO CPF', 'RG RESPONSAVEL',
                    'TELEFONE', 'ENDERE√áO COMPLETO', 'N CS', 'BAIRRO', 'CEP', 'CID/EST',
                    'NOME DO ALUNO', 'CPF DO ALUNO', 'RG ALUNO', 'PROFISSIONALIZANTE',
                    'CARGA HOR√ÅRIA', 'VALOR TOTAL', 'VALOR √Ä VISTA', 'DESCONTO',
                    'N√öMERO DE PARCELAS', 'VALOR PARCELA'
                ].sort();
                log('status-placeholders', '‚ö†Ô∏è Usando lista manual de placeholders', 'info');
            }
            
            const extras = ['MODELO', 'FORMA_PAGAMENTO', 'DATA_GERACAO', 'VERSAO'];
            
            const lista = `PLACEHOLDERS DISPON√çVEIS PARA TEMPLATES:

PLACEHOLDERS PRINCIPAIS:
${placeholders.map(p => `{{${p}}}`).join('\n')}

PLACEHOLDERS EXTRAS:
${extras.map(p => `{{${p}}}`).join('\n')}

INSTRU√á√ïES:
1. Use estes placeholders exatamente como mostrado (com chaves duplas)
2. O sistema substituir√° automaticamente pelos dados do formul√°rio
3. Placeholders n√£o encontrados permanecer√£o vazios
4. Teste com o template exemplo primeiro

Total: ${placeholders.length + extras.length} placeholders dispon√≠veis`;
            
            // Criar arquivo
            const blob = new Blob([lista], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Lista_Placeholders_Teste.txt';
            a.click();
            URL.revokeObjectURL(url);
            
            log('status-placeholders', `‚úÖ Lista de ${placeholders.length + extras.length} placeholders baixada!<br>Arquivo: <code>Lista_Placeholders_Teste.txt</code>`, 'success');
        }

        function testarMapeamento() {
            log('status-mapping', 'üîÑ Testando mapeamento de placeholders...', 'info');
            
            // Simular mapeamento (mesmo sem PLACEHOLDERS_CANONICOS)
            const textoExemplo = "Nome: {{NOME COMPLETO}} | CPF: {{N√öMERO DO CPF}} | Aluno: {{NOME DO ALUNO}} | Curso: {{PROFISSIONALIZANTE}}";
            
            let textoProcessado = textoExemplo;
            let substituicoes = 0;
            
            // Substituir placeholders usando DADOS_EXEMPLO
            Object.keys(DADOS_EXEMPLO).forEach(key => {
                const placeholder = `{{${key}}}`;
                if (textoProcessado.includes(placeholder)) {
                    const regex = new RegExp(placeholder.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
                    textoProcessado = textoProcessado.replace(regex, DADOS_EXEMPLO[key]);
                    substituicoes++;
                }
            });
            
            // Status do sistema de mapeamento
            let statusSistema = 'Funcionando com dados de exemplo';
            if (window.PLACEHOLDERS_CANONICOS) {
                statusSistema = '‚úÖ Sistema completo dispon√≠vel';
            } else if (window.ContractExports) {
                statusSistema = '‚ö†Ô∏è Sistema parcial (sem PLACEHOLDERS_CANONICOS)';
            } else {
                statusSistema = '‚ùå Sistema principal n√£o carregado';
            }
            
            const resultado = `
                <strong>Texto Original:</strong><br>
                <code>${textoExemplo}</code><br><br>
                
                <strong>Texto Processado:</strong><br>
                <code>${textoProcessado}</code><br><br>
                
                <strong>Estat√≠sticas:</strong><br>
                ‚Ä¢ ${substituicoes} placeholders substitu√≠dos<br>
                ‚Ä¢ ${Object.keys(DADOS_EXEMPLO).length} dados de exemplo dispon√≠veis<br>
                ‚Ä¢ Status: ${statusSistema}<br><br>
                
                <strong>Teste de Sistema:</strong><br>
                ${window.PLACEHOLDERS_CANONICOS ? '‚úÖ' : '‚ùå'} PLACEHOLDERS_CANONICOS<br>
                ${window.ContractExports ? '‚úÖ' : '‚ùå'} ContractExports<br>
                ${window.titleCase ? '‚úÖ' : '‚ùå'} titleCase<br>
                ${window.maskCPF ? '‚úÖ' : '‚ùå'} maskCPF
            `;
            
            log('status-mapping', resultado, substituicoes > 0 ? 'success' : 'error');
        }

        // Executar teste inicial
        window.onload = function() {
            setTimeout(testarDependencias, 1000);
        };
    </script>
</body>
</html>