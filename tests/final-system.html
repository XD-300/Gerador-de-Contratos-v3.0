<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Final - Sistema de Templates</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-style: italic;
        }
        
        .section {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        .section h3 {
            margin-top: 0;
            color: #007bff;
        }
        
        button {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.4);
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 2px dashed #007bff;
            border-radius: 8px;
            background: #f8f9fa;
            margin: 10px 0;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
        
        .highlight {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Teste Final do Sistema de Templates</h1>
        <p class="subtitle">VerificaÃ§Ã£o completa da funcionalidade de download</p>
        
        <div class="highlight">
            <strong>ğŸ“‹ Status:</strong> <span id="status-geral">Inicializando...</span>
        </div>
        
        <div class="section">
            <h3>1. ğŸ” VerificaÃ§Ã£o Completa de DependÃªncias</h3>
            <button onclick="verificarTudo()">ğŸ” Verificar Todas as DependÃªncias</button>
            <div id="deps-result" class="status info" style="display: none;"></div>
        </div>
        
        <div class="grid">
            <div class="section">
                <h3>2. ğŸ“ Teste de GeraÃ§Ã£o DOCX</h3>
                <button onclick="testarGeracao()">ğŸš€ Gerar DOCX de Teste</button>
                <div id="gen-result" class="status info" style="display: none;"></div>
            </div>
            
            <div class="section">
                <h3>3. ğŸ“„ Sistema de Templates</h3>
                <input type="file" id="templateFile" accept=".docx" placeholder="Selecione um template...">
                <button onclick="processarTemplate()" id="btnProcessar" disabled>ğŸ“‹ Processar Template</button>
                <div id="template-result" class="status info" style="display: none;"></div>
            </div>
        </div>
        
        <div class="section">
            <h3>4. ğŸ¯ SimulaÃ§Ã£o Completa do Sistema Principal</h3>
            <p>Esta seÃ§Ã£o simula exatamente como funciona no sistema principal:</p>
            <div class="grid">
                <div>
                    <button onclick="preencherDadosExemplo()">ğŸ“ Preencher Dados de Exemplo</button>
                    <button onclick="gerarComDados()">ğŸ¯ Gerar com Dados do FormulÃ¡rio</button>
                </div>
                <div>
                    <button onclick="abrirSistemaPrincipal()">ğŸŒ Abrir Sistema Principal</button>
                    <button onclick="mostrarInstrucoes()">ğŸ“– Ver InstruÃ§Ãµes</button>
                </div>
            </div>
            <div id="sim-result" class="status info" style="display: none;"></div>
        </div>
        
        <div class="section">
            <h3>5. ğŸ“Š RelatÃ³rio Final</h3>
            <button onclick="gerarRelatorio()">ğŸ“‹ Gerar RelatÃ³rio Completo</button>
            <div id="report-result" class="status info" style="display: none;"></div>
        </div>
    </div>

    <!-- Bibliotecas -->
    <script src="https://cdn.jsdelivr.net/npm/docx@7.8.2/build/index.js"></script>
    <script src="../src/core/utils.js"></script>
    <script src="../src/core/calculations.js"></script>
    <script src="../src/core/exports.js"></script>
    
    <script>
        let templateFileGlobal = null;
        let testResults = {};
        
        // InicializaÃ§Ã£o
        window.onload = function() {
            document.getElementById('status-geral').textContent = 'Aguardando verificaÃ§Ã£o...';
            
            // Setup do upload
            document.getElementById('templateFile').addEventListener('change', (e) => {
                templateFileGlobal = e.target.files[0];
                const btn = document.getElementById('btnProcessar');
                if (templateFileGlobal && templateFileGlobal.name.toLowerCase().endsWith('.docx')) {
                    btn.disabled = false;
                    btn.textContent = `ğŸ“‹ Processar ${templateFileGlobal.name}`;
                    log('template-result', `ğŸ“ Template carregado: ${templateFileGlobal.name}`, 'success');
                } else {
                    btn.disabled = true;
                    btn.textContent = 'ğŸ“‹ Processar Template';
                    if (templateFileGlobal) {
                        log('template-result', 'âŒ Arquivo deve ser .docx', 'error');
                    }
                }
            });
            
            setTimeout(verificarTudo, 500);
        };
        
        function log(elementId, message, type = 'info') {
            const el = document.getElementById(elementId);
            el.style.display = 'block';
            el.className = `status ${type}`;
            el.textContent = message;
        }
        
        function verificarTudo() {
            log('deps-result', 'ğŸ”„ Verificando todas as dependÃªncias...', 'info');
            
            setTimeout(() => {
                const deps = [
                    { name: 'window.docx', check: () => window.docx?.Document },
                    { name: 'window.docx.Packer', check: () => window.docx?.Packer },
                    { name: 'PLACEHOLDERS_CANONICOS', check: () => window.PLACEHOLDERS_CANONICOS },
                    { name: 'titleCase', check: () => window.titleCase },
                    { name: 'maskCPF', check: () => window.maskCPF },
                    { name: 'ContractUtils', check: () => window.ContractUtils },
                    { name: 'ContractCalculations', check: () => window.ContractCalculations },
                    { name: 'ContractExports', check: () => window.ContractExports }
                ];
                
                const results = deps.map(dep => ({
                    name: dep.name,
                    loaded: !!dep.check(),
                    status: dep.check() ? 'âœ…' : 'âŒ'
                }));
                
                const loaded = results.filter(r => r.loaded).length;
                const total = results.length;
                
                testResults.dependencies = { loaded, total, details: results };
                
                let message = `VERIFICAÃ‡ÃƒO DE DEPENDÃŠNCIAS (${loaded}/${total}):\\n\\n`;
                message += results.map(r => `${r.status} ${r.name}`).join('\\n');
                message += `\\n\\n`;
                
                if (loaded === total) {
                    message += 'ğŸ‰ TODAS AS DEPENDÃŠNCIAS CARREGADAS!\\nSistema pronto para uso.';
                    document.getElementById('status-geral').textContent = 'âœ… Sistema Totalmente Funcional';
                    log('deps-result', message, 'success');
                } else {
                    const missing = results.filter(r => !r.loaded).map(r => r.name);
                    message += `âš ï¸ DEPENDÃŠNCIAS FALTANDO:\\n${missing.join(', ')}\\n\\nAlgumas funcionalidades podem nÃ£o funcionar.`;
                    document.getElementById('status-geral').textContent = `âš ï¸ ${total - loaded} dependÃªncias faltando`;
                    log('deps-result', message, 'error');
                }
                
                // Teste especÃ­fico do docx
                if (window.docx) {
                    try {
                        const { Document, Paragraph, TextRun } = window.docx;
                        const testDoc = new Document({
                            sections: [{ properties: {}, children: [new Paragraph({ children: [new TextRun("test")] })] }]
                        });
                        message += '\\n\\nâœ… Biblioteca docx funcionando perfeitamente';
                        testResults.docxWorking = true;
                    } catch (error) {
                        message += `\\n\\nâŒ Erro na biblioteca docx: ${error.message}`;
                        testResults.docxWorking = false;
                    }
                    log('deps-result', message, loaded === total ? 'success' : 'error');
                }
            }, 500);
        }
        
        async function testarGeracao() {
            log('gen-result', 'ğŸ”„ Testando geraÃ§Ã£o de DOCX...', 'info');
            
            try {
                if (!window.docx) {
                    throw new Error('Biblioteca docx nÃ£o carregada');
                }
                
                const { Document, Paragraph, TextRun, Packer } = window.docx;
                
                const doc = new Document({
                    sections: [{
                        properties: {},
                        children: [
                            new Paragraph({
                                children: [new TextRun({
                                    text: "ğŸ§ª TESTE DE GERAÃ‡ÃƒO DOCX",
                                    bold: true,
                                    size: 32
                                })]
                            }),
                            new Paragraph({ text: "" }),
                            new Paragraph({
                                children: [new TextRun(`Gerado em: ${new Date().toLocaleString('pt-BR')}`)]
                            }),
                            new Paragraph({
                                children: [new TextRun({
                                    text: "âœ… Sistema de geraÃ§Ã£o funcionando corretamente!",
                                    color: "00AA00"
                                })]
                            })
                        ]
                    }]
                });
                
                const buffer = await Packer.toBlob(doc);
                const url = URL.createObjectURL(buffer);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = 'teste_geracao.docx';
                a.click();
                
                setTimeout(() => URL.revokeObjectURL(url), 1000);
                
                testResults.generation = { success: true, time: new Date() };
                log('gen-result', 'âœ… GERAÃ‡ÃƒO FUNCIONANDO!\\nArquivo teste_geracao.docx baixado com sucesso.', 'success');
                
            } catch (error) {
                testResults.generation = { success: false, error: error.message };
                log('gen-result', `âŒ Erro na geraÃ§Ã£o: ${error.message}`, 'error');
            }
        }
        
        async function processarTemplate() {
            if (!templateFileGlobal) {
                log('template-result', 'âŒ Nenhum template selecionado', 'error');
                return;
            }
            
            log('template-result', `ğŸ”„ Processando ${templateFileGlobal.name}...`, 'info');
            
            try {
                // Simula o sistema principal
                const dados = {
                    'CONTRATO': '2024001',
                    'DATA': new Date().toLocaleDateString('pt-BR'),
                    'NOME COMPLETO': 'JoÃ£o Silva Santos',
                    'NÃšMERO DO CPF': '123.456.789-00',
                    'TELEFONE': '(11) 99999-9999',
                    'NOME DO ALUNO': 'Maria Silva Santos',
                    'PROFISSIONALIZANTE': 'TÃ©cnico em InformÃ¡tica',
                    'VALOR TOTAL': 'R$ 2.400,00'
                };
                
                if (window.ContractExports && window.ContractExports.preencherTemplateDOCX) {
                    // Usa o sistema real
                    await window.ContractExports.preencherTemplateDOCX(templateFileGlobal);
                    testResults.template = { success: true, method: 'ContractExports' };
                } else {
                    // Fallback: cria documento com dados
                    const { Document, Paragraph, TextRun, Packer } = window.docx;
                    
                    const doc = new Document({
                        sections: [{
                            properties: {},
                            children: [
                                new Paragraph({
                                    children: [new TextRun({
                                        text: `ğŸ“‹ TEMPLATE PROCESSADO: ${templateFileGlobal.name}`,
                                        bold: true,
                                        size: 28
                                    })]
                                }),
                                new Paragraph({ text: "" }),
                                ...Object.entries(dados).map(([campo, valor]) =>
                                    new Paragraph({
                                        children: [
                                            new TextRun({ text: `${campo}: `, bold: true }),
                                            new TextRun({ text: valor })
                                        ]
                                    })
                                )
                            ]
                        }]
                    });
                    
                    const buffer = await Packer.toBlob(doc);
                    const url = URL.createObjectURL(buffer);
                    
                    const nome = templateFileGlobal.name.replace(/\.docx$/i, '_preenchido.docx');
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = nome;
                    a.click();
                    
                    setTimeout(() => URL.revokeObjectURL(url), 1000);
                    testResults.template = { success: true, method: 'fallback' };
                }
                
                log('template-result', `âœ… TEMPLATE PROCESSADO!\\nArquivo baixado com sucesso.\\n\\nMÃ©todo: ${testResults.template.method}`, 'success');
                
            } catch (error) {
                testResults.template = { success: false, error: error.message };
                log('template-result', `âŒ Erro ao processar template: ${error.message}`, 'error');
            }
        }
        
        function preencherDadosExemplo() {
            log('sim-result', 'ğŸ“ Dados de exemplo preenchidos!\\n\\nEste seria o resultado no sistema principal:\\nâ€¢ Nome: JoÃ£o Silva Santos\\nâ€¢ CPF: 123.456.789-00\\nâ€¢ Curso: TÃ©cnico em InformÃ¡tica\\nâ€¢ Valor: R$ 2.400,00', 'success');
        }
        
        async function gerarComDados() {
            log('sim-result', 'ğŸ”„ Simulando geraÃ§Ã£o com dados do formulÃ¡rio...', 'info');
            
            try {
                if (window.ContractExports && window.ContractExports.collectData) {
                    log('sim-result', 'âœ… SISTEMA PRINCIPAL FUNCIONANDO!\\n\\nContractExports.collectData disponÃ­vel\\nSistema pronto para gerar documentos', 'success');
                } else {
                    log('sim-result', 'âš ï¸ Sistema parcial\\n\\nContractExports nÃ£o totalmente carregado\\nFunÃ§Ãµes bÃ¡sicas disponÃ­veis', 'error');
                }
            } catch (error) {
                log('sim-result', `âŒ Erro: ${error.message}`, 'error');
            }
        }
        
        function abrirSistemaPrincipal() {
            window.open('../index.html', '_blank');
        }
        
        function mostrarInstrucoes() {
            const instrucoes = `
ğŸ¯ COMO USAR O SISTEMA DE TEMPLATES:

1. ğŸ“‹ PREPARAR TEMPLATE:
   â€¢ Crie documento Word (.docx)
   â€¢ Use placeholders: {{NOME COMPLETO}}, {{CPF}}, etc.
   â€¢ Salve como .docx

2. ğŸŒ NO SISTEMA PRINCIPAL:
   â€¢ Abra index.html
   â€¢ Preencha dados do formulÃ¡rio
   â€¢ SeÃ§Ã£o "Sistema de Templates DOCX"
   â€¢ FaÃ§a upload do template
   â€¢ Clique "Preencher Template"

3. âœ… RESULTADO:
   â€¢ Download automÃ¡tico
   â€¢ Arquivo _preenchido.docx
   â€¢ Dados substituÃ­dos automaticamente

4. ğŸ¯ BOTÃƒO PRINCIPAL:
   â€¢ "Baixar Template Preenchido"
   â€¢ SÃ³ funciona com template carregado
   â€¢ Usa dados do formulÃ¡rio atual
            `;
            
            log('sim-result', instrucoes.trim(), 'info');
        }
        
        function gerarRelatorio() {
            const report = {
                timestamp: new Date().toLocaleString('pt-BR'),
                ...testResults
            };
            
            let relatorio = `ğŸ“Š RELATÃ“RIO FINAL DO SISTEMA\\n`;
            relatorio += `â° ${report.timestamp}\\n\\n`;
            
            // DependÃªncias
            if (report.dependencies) {
                relatorio += `ğŸ”— DEPENDÃŠNCIAS: ${report.dependencies.loaded}/${report.dependencies.total}\\n`;
                relatorio += report.dependencies.loaded === report.dependencies.total ? 'âœ… Todas carregadas\\n' : 'âš ï¸ Algumas faltando\\n';
            }
            
            // DOCX
            relatorio += `ğŸ“„ BIBLIOTECA DOCX: ${report.docxWorking ? 'âœ… Funcionando' : 'âŒ Com problemas'}\\n`;
            
            // GeraÃ§Ã£o
            if (report.generation) {
                relatorio += `ğŸš€ GERAÃ‡ÃƒO: ${report.generation.success ? 'âœ… Funcionando' : 'âŒ Com problemas'}\\n`;
            }
            
            // Template
            if (report.template) {
                relatorio += `ğŸ“‹ TEMPLATES: ${report.template.success ? 'âœ… Funcionando' : 'âŒ Com problemas'}\\n`;
            }
            
            relatorio += `\\nğŸ¯ CONCLUSÃƒO:\\n`;
            
            const allWorking = report.docxWorking && 
                              (!report.generation || report.generation.success) && 
                              (!report.template || report.template.success);
            
            if (allWorking) {
                relatorio += 'âœ… SISTEMA TOTALMENTE FUNCIONAL!\\nTodos os testes passaram.\\nSistema pronto para uso em produÃ§Ã£o.';
                document.getElementById('status-geral').textContent = 'ğŸ‰ Sistema 100% Funcional';
            } else {
                relatorio += 'âš ï¸ SISTEMA COM LIMITAÃ‡Ã•ES\\nAlgumas funcionalidades podem nÃ£o funcionar.\\nVerifique os testes individuais.';
                document.getElementById('status-geral').textContent = 'âš ï¸ Sistema Parcialmente Funcional';
            }
            
            log('report-result', relatorio, allWorking ? 'success' : 'error');
            
            // Salva relatÃ³rio
            const blob = new Blob([relatorio.replace(/\\n/g, '\\n')], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `relatorio_sistema_${Date.now()}.txt`;
            a.click();
            setTimeout(() => URL.revokeObjectURL(url), 1000);
        }
    </script>
</body>
</html>