<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <!-- FAVICON CORE -->

  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/x-icon" href="favicon.ico">

  <!-- ANDROID / CHROME -->
  <link rel="icon" type="image/png" sizes="192x192" href="android-chrome-192x192-convertido-de-jpg.png">
  <link rel="icon" type="image/png" sizes="512x512" href="android-chrome-512x512-convertido-de-jpg.png">

  <!-- APPLE / IOS -->
  <link rel="apple-touch-icon" href="apple-touch-icon.png">

  <!-- PWA (opcional, mas recomendado) -->
  <link rel="manifest" href="site.webmanifest">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gerador de Contratos (Web)</title>
  
  <!-- Bibliotecas locais (prioridade) -->
  <script src="src/export/libs/pizzip.min.js"></script>
  <script src="src/export/libs/docxtemplater.js"></script>

  <!-- Folha de estilos -->
  <link rel="stylesheet" href="src/styles/main.css">
  <style>#sec-templates { display: none !important; }</style>
  <link rel="stylesheet" href="src/styles/auto-calc.css">
  <link rel="stylesheet" href="src/styles/validations.css">

  <!-- Modal de relat√≥rio t√©cnico do download DOCX -->
  <style>
    /* Modal de relat√≥rio */
    #relatorio-modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 9999; }
    #relatorio-modal.show { display: flex; }
    #relatorio-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,.5); }
    #relatorio-card {
      position: relative; width: min(820px, 92vw); max-height: 80vh; overflow: hidden;
      background: #0f172a; color: #e2e8f0; border-radius: 14px; box-shadow: 0 10px 30px rgba(0,0,0,.4);
      border: 1px solid rgba(148,163,184,.25);
    }
    #relatorio-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid rgba(148,163,184,.25); }
    #relatorio-title { font-weight: 700; font-size: 16px; }
    #relatorio-body { padding: 0; }
    #relatorio-pre {
      margin: 0; padding: 14px 16px; white-space: pre-wrap; overflow: auto; max-height: calc(80vh - 100px);
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: 12.5px; line-height: 1.45;
      background: #0b1220;
    }
    #relatorio-actions { display:flex; gap: 8px; padding: 12px 16px; border-top: 1px solid rgba(148,163,184,.25); justify-content: flex-end;}
    .btn-rel { background: #334155; border: 1px solid rgba(148,163,184,.25); color: #e2e8f0; padding: 6px 10px; border-radius: 8px; cursor: pointer; }
    .btn-rel.primary { background: linear-gradient(180deg,#3b82f6,#2563eb); border: none; }
  </style>
  
  <!-- Carregamento LOCAL-FIRST das bibliotecas de template com fallbacks -->
  <script>
    // ...existing code...
    document.addEventListener('DOMContentLoaded', () => {
      // diagn√≥stico leve por ~10s
      let tries = 0, max = 20;
      const t = setInterval(() => {
        const ok = !!(window.PizZip && (window.Docxtemplater || window.docxtemplater));
  console.log('üîç PizZip:', !!window.PizZip, '| Docxtemplater:', !!(window.Docxtemplater || window.docxtemplater));
        if (ok || ++tries >= max) clearInterval(t);
      }, 500);
    });
  </script>

  <!-- Sistema de persist√™ncia de prefer√™ncias -->
  <script>
    // Salva e restaura as prefer√™ncias do usu√°rio
    document.addEventListener('DOMContentLoaded', function() {
        // Remove a prefer√™ncia de forma de pagamento do localStorage
        localStorage.removeItem('gerador_forma_pagamento');
      // Elementos que ser√£o persistidos
      const modeloSelect = document.getElementById('modelo');
      const formaSelect = document.getElementById('forma');
      
      // Preenche data automaticamente com a data atual
      function preencherDataAtual() {
        const dataInput = document.getElementById('data');
        if (dataInput && !dataInput.value) {
          const hoje = new Date();
          const dia = String(hoje.getDate()).padStart(2, '0');
          const mes = String(hoje.getMonth() + 1).padStart(2, '0');
          const ano = hoje.getFullYear();
          const dataFormatada = `${dia}/${mes}/${ano}`;
          
          dataInput.value = dataFormatada;
          console.log('üìÖ Data atual preenchida automaticamente:', dataFormatada);
        }
      }
      
      // Restaura valores salvos ao carregar a p√°gina
      function restaurarPreferencias() {
        const modeloSalvo = localStorage.getItem('gerador_modelo_contrato');
        let formaSalva = localStorage.getItem('gerador_forma_pagamento');

        if (modeloSalvo && modeloSelect) {
          modeloSelect.value = modeloSalvo;
          console.log('üîÑ Modelo restaurado:', modeloSalvo);
        }

        if (formaSalva && formaSelect) {
          const f = formaSalva.toLowerCase();

          if (f === 'boleto') formaSelect.value = 'Boleto';
          else if (f === 'cart√£o' || f === 'cartao') formaSelect.value = 'Cart√£o';
          else if (f === '√† vista' || f === 'avista' || f === 'a vista') formaSelect.value = '√Ä vista';
          else formaSelect.value = formaSalva; // caso j√° esteja certinho

          console.log('üîÑ Forma de pagamento restaurada (normalizada):', formaSelect.value);

          formaSelect.dispatchEvent(new Event('change'));
        }

        preencherDataAtual();
      }
      
      // Salva modelo quando alterado
      if (modeloSelect) {
        modeloSelect.addEventListener('change', function() {
          localStorage.setItem('gerador_modelo_contrato', this.value);
          console.log('üíæ Modelo salvo:', this.value);
        });
      }
      
      // Salva forma de pagamento quando alterada
      if (formaSelect) {
        formaSelect.addEventListener('change', function() {
          localStorage.setItem('gerador_forma_pagamento', this.value);
          console.log('üíæ Forma de pagamento salva:', this.value);
        });
      }
      
      // Restaura prefer√™ncias ap√≥s breve delay para garantir que os elementos estejam prontos
      setTimeout(restaurarPreferencias, 100);
    });
  </script>

  <!-- Ordem de carregamento dos m√≥dulos (atualizada) -->
  <script src="src/app/utils.js"></script>
  <script src="src/app/mapping/placeholders-map.js"></script>
  <script src="src/app/automations.js"></script>
  <script src="src/app/relatorio.js"></script>
  <script src="src/app/validations/validacao_exemplo.js"></script>
  <script src="src/app/validations/validacao_cidadeUf.js"></script>
  <script src="src/app/main.js"></script>
  <script src="src/auto-calc/engine.js"></script>
  <script src="src/auto-calc/init.js"></script>

  <!-- libs de exporta√ß√£o -->
  <script src="src/export/exports.js"></script>
  <script src="libs/xlsx.full.min.js"></script>

  <!-- Debug listener para eventos DOCX -->
  <script>
    // Listener de debug para eventos DOCX
    window.addEventListener('docx:downloaded', e => console.log('[EV] docx:downloaded:', e.detail));
    window.addEventListener('docx:generated', e => console.log('[EV] docx:generated:', e.detail));
    window.addEventListener('gerarDocx', e => console.log('[EV] gerarDocx:', e.detail));
  </script>

  <!-- Reporter do Fluxo de Exporta√ß√£o DOCX ‚Äì n√£o altera o fluxo, s√≥ registra -->
  <script>
  (function () {
    console.log('[Relatorio] Snippet passivo carregado e ativo!');
    let R = null;

    // 1) Clique no bot√£o: in√≠cio do relat√≥rio (at√© antes do dispatch)
    document.addEventListener('DOMContentLoaded', function () {
      const btn = document.getElementById('btnDocx');
      if (!btn) return;

      btn.addEventListener('click', () => {
        // (Re)come√ßa um relat√≥rio novo a cada clique
        R = Relatorio.create('Fluxo de Exporta√ß√£o DOCX')
          .env(() => ({
            pizzip: !!window.PizZip,
            docxtemplater: !!(window.Docxtemplater || window.docxtemplater),
            docx: !!(window.docx && window.docx.Packer && window.docx.Document)
          }))
          .ok('1) Usu√°rio clicou em üìù Gerar DOCX (#btnDocx)')
          .ok('2) Salvamento no hist√≥rico ser√° executado pelo handler do bot√£o')
          .check('DOM pronto', ['interactive','complete'].includes(document.readyState), document.readyState)
          .check('Bibliotecas: docx', !!(window.docx && window.docx.Packer && window.docx.Document))
          .check('Bibliotecas: PizZip+Docxtemplater', !!(window.PizZip && (window.Docxtemplater || window.docxtemplater)));
      }, { capture: true }); // captura para logar antes de outros listeners
    });

    // 2) Evento customizado: quando o fluxo real dispara 'gerarDocx'
    window.addEventListener('gerarDocx', () => {
      if (!R) return;
      R.ok("3) Evento customizado disparado: window.dispatchEvent(new CustomEvent('gerarDocx'))");

      // Coleta dos campos (espelha seu formul√°rio atual)
      const get = (id) => document.getElementById(id)?.value || '';
      const dados = {
        modelo: get('modelo'),
        forma: get('forma'),
        dataContrato: get('data'),
        responsavel: get('nomeResp'),
        aluno: get('nomeAluno'),
        curso: get('curso'),
        valorTotal: get('total'),
        templateSelecionado: document.getElementById('templateUpload')?.files?.[0]?.name || '(nenhum)'
      };
      R.attach('4) Campos coletados do formul√°rio', dados);

      // Template selecionado e libs
      const temTemplate = !!document.getElementById('templateUpload')?.files?.length;
      R.check('Template selecionado', temTemplate, dados.templateSelecionado);

      // Observa√ß√£o do pr√≥ximo passo (executado nos m√≥dulos de exporta√ß√£o)
      R.ok('5) M√≥dulo de exporta√ß√£o ir√°: selecionar template, preencher placeholders, gerar DOCX (Docxtemplater/PizZip) e ofertar download');
    });

    // 3) (Opcional) Se o seu m√≥dulo de exporta√ß√£o emitir estes eventos, registramos tamb√©m:
    //    window.dispatchEvent(new CustomEvent('docx:generated', {detail:{filename, size}}))
    //    window.dispatchEvent(new CustomEvent('docx:downloaded', {detail:{filename}}))
    window.addEventListener('docx:generated', (e) => {
      if (!R) return;
      const { filename, size } = e.detail || {};
      if (size != null) R.metric('Tamanho do DOCX', size, 'bytes');
      R.ok(`6) DOCX gerado: ${filename || '(sem nome)'}`);
    });
    window.addEventListener('docx:downloaded', (e) => {
  if (!R) return;
  const { filename } = e.detail || {};
  R.ok(`7) Download oferecido ao usu√°rio: ${filename || '(sem nome)'}`);
  R.end('concluido').toConsole();
  // Popup √© gerenciado pelo sistema auto-contido no final do HTML
  // Se quiser tamb√©m salvar arquivo do relat√≥rio:
  // R.downloadTXT('relatorio_exportacao.txt');
    });

    // 4) Timeout de seguran√ßa: encerra o relat√≥rio mesmo sem eventos opcionais
    window.addEventListener('gerarDocx', () => {
      if (!R) return;
      setTimeout(() => { if (R && !R.result) R.end('concluido').toConsole(); }, 3000);
    });
  })();
  </script>

  <script>
  // Integra√ß√£o: sempre que clicar no bot√£o Gerar DOCX, executa diagn√≥stico e alerta
  document.addEventListener('DOMContentLoaded', function() {
    var btnDocx = document.getElementById('btnDocx');
    if (btnDocx) {
      btnDocx.addEventListener('click', async function(e) {
        // Diagn√≥stico completo
        const R = Relatorio.create('Diagn√≥stico de Exporta√ß√£o DOCX')
          .env(() => ({
            pizzip: !!window.PizZip,
            docxtemplater: !!(window.Docxtemplater || window.docxtemplater),
            docx: !!(window.docx && window.docx.Packer && window.docx.Document)
          }));

        // Checks de pr√©-voo
        R.check('DOM pronto', document.readyState === 'interactive' || document.readyState === 'complete', document.readyState);
        R.check('docx dispon√≠vel', !!(window.docx && window.docx.Packer && window.docx.Document));


  // Coleta campos principais e detalhes
  const modelo = document.getElementById('modelo')?.value || '';
  const forma = document.getElementById('forma')?.value || '';
  const dataContrato = document.getElementById('data')?.value || '';
  const nomeResp = document.getElementById('nomeResp')?.value || '';
  const nomeAluno = document.getElementById('nomeAluno')?.value || '';
  const curso = document.getElementById('curso')?.value || '';
  const total = document.getElementById('total')?.value || '';
  const template = document.getElementById('templateNome')?.textContent || '-';
  R.attach('Campos coletados', { modelo, forma, dataContrato, nomeResp, nomeAluno, curso, total, template });

        // Valida√ß√£o b√°sica
  let erros = [];
  if (!(nomeResp || nomeAluno)) erros.push('Nome do respons√°vel/aluno ausente');
        if (!curso) erros.push('Curso ausente');
        if (!total) erros.push('Valor total ausente');
        if (!window.docx || !window.docx.Packer) erros.push('Biblioteca docx n√£o carregada');

        // Exemplo de etapa de gera√ß√£o (n√£o gera arquivo real aqui)
        try {
          await R.run('validacao', async () => {
            if (erros.length) throw new Error(erros.join('; '));
          });
          R.ok('Pronto para exportar.');
        } catch (e) {
          R.error(e);
        }

        R.end(erros.length ? 'falhou' : 'concluido');

        // Gera mensagem de alerta com resumo e detalhes
        let msg = `Relat√≥rio de Exporta√ß√£o:\n`;
        msg += `Modelo: ${modelo}\nForma: ${forma}\nData: ${dataContrato}\n`;
        msg += `Respons√°vel: ${nomeResp}\nAluno: ${nomeAluno}\nCurso: ${curso}\nValor total: ${total}\n`;
        msg += `Template: ${template}\n`;
        msg += `Libs: docx=${!!window.docx}, PizZip=${!!window.PizZip}, Docxtemplater=${!!(window.Docxtemplater||window.docxtemplater)}, TemplateReady=${!!window.templateLibrariesReady}\n`;
        if (erros.length) {
          msg += '\n‚ö†Ô∏è Problemas encontrados:\n- ' + erros.join('\n- ');
        } else {
          msg += '\n‚úÖ Tudo pronto para exporta√ß√£o!';
        }
        alert(msg);
        // Opcional: imprime no console
        R.toConsole();
      });
    }
  });
  </script>
</head>
<body>
  <header>
    <h1>üéØ Gerador de Contratos v3.0</h1>
    <div class="sub">
      Feito por G. S. Sousa
    </div>
  </header>

  <main class="grid">
    <!-- Configura√ß√µes gerais -->
         <section class="card" id="sec-geral">
      <div>

      </div>
      <div>
        <label>Forma de Pagamento</label>
        <select id="forma">
          <option value="avista">√Ä vista</option>
          <option value="cartao">Cart√£o de Cr√©dito</option>
          <option value="boleto">Boleto Banc√°rio</option>
        </select>
      </div>
      <div>
        <label>Data do Contrato</label>
        <input id="data" placeholder="DD/MM/AAAA" autocomplete="off" />
      </div>
      <div class="inline" style="margin-top:22px; display: flex; justify-content: space-between; align-items: center;">
        <div>
          <span class="pill" id="pill-status">Ligado</span>
          <label class="hint">
            <input type="checkbox" id="auto" checked style="width:auto; margin-right:6px"/> 
            C√°lculo autom√°tico
          </label>
        </div>
        <button
          type="button"
          class="btn ghost"
          id="btnExemplo"
          title="F5"
          style="font-size: 11px; padding: 6px 10px; width: auto; min-width: auto;"
        >
          üìù
        </button>
      </div>
    </section>

    <!-- Dados do respons√°vel financeiro -->
    <section class="card">
      <h2>Respons√°vel Financeiro</h2>
      <div class="grid cols-2">
        <div>
          <label>Nome completo</label>
          <input id="nomeResp" placeholder="Ex.: Maria da Silva Santos" autocomplete="name" />
        </div>
        <div>
          <label>Data de nascimento</label>
          <input id="nascResp" placeholder="DD/MM/AAAA" autocomplete="bday" />
        </div>
        <div>
          <label>CPF</label>
          <input id="cpfResp" placeholder="000.000.000-00" autocomplete="off" />
        </div>
        <div>
          <label>RG</label>
          <input id="rgResp" placeholder="00.000.000-0" />
        </div>
        <div>
          <label>Telefone</label>
          <input id="telResp" placeholder="(99) 99999-9999" autocomplete="tel" />
        </div>
      </div>
      
      <hr style="border: none; border-top: 1px solid var(--border); margin: 16px 0" />
      
      <div class="grid cols-3">
        <div>
          <label>Endere√ßo completo</label>
          <input id="endereco" placeholder="Rua, Avenida..." autocomplete="address-line1" />
        </div>
        <div>
          <label>N√∫mero</label>
          <input id="numero" placeholder="123" />
        </div>
        <div>
          <label>Bairro</label>
          <input id="bairro" placeholder="Centro" />
        </div>
        <div>
          <label>CEP</label>
          <input id="cep" placeholder="00000-000" autocomplete="postal-code" />
        </div>
        <div>
          <label>Cidade/UF</label>
          <input id="cidadeUf" placeholder="S√£o Paulo/SP" />
        </div>
      </div>
    </section>

    <!-- Dados do aluno -->
    <section class="card">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
        <h2 style="margin: 0;">Dados do Aluno</h2>
        <button type="button" class="btn ghost" id="btnCopiarResp" title="Copiar dados do respons√°vel para o aluno" style="font-size: 11px; padding: 4px 8px; width: auto; min-width: auto;">
          üìã
        </button>
      </div>
      <div class="grid cols-4">
        <div style="grid-column: span 2;">
          <label>Nome do aluno</label>
          <input id="nomeAluno" placeholder="Nome completo do estudante" />
        </div>
        <div>
          <label>Data de nascimento</label>
          <input id="nascAluno" placeholder="DD/MM/AAAA" />
        </div>
        <div>
          <label>Sexo</label>
          <select id="sexoAluno">
            <option value="">‚Äî Selecionar ‚Äî</option>
            <option value="M">Masculino</option>
            <option value="F">Feminino</option>
          </select>
        </div>
        <div>
          <label>RG do aluno</label>
          <input id="rgAluno" placeholder="00.000.000-0" />
        </div>
        <div>
          <label>CPF do aluno</label>
          <input id="cpfAluno" placeholder="000.000.000-00" />
        </div>
        <div>
          <label>Registro Acad√™mico (R.A)</label>
          <input id="raAluno" placeholder="RA2024001" />
        </div>
      </div>
    </section>

    <!-- Informa√ß√µes do curso -->
    <section class="card">
      <h2>Dados do Curso</h2>
      <div class="grid cols-3">
        <div>
          <label>Curso</label>
          <input id="curso" placeholder="Nome completo do curso" />
        </div>
        <div>
          <label>Carga hor√°ria</label>
          <input id="carga" placeholder="Ex.: 160h, 1200h" />
        </div>
        <div>
          <label>N√∫mero do contrato</label>
          <input id="contrato" placeholder="001/2025" />
        </div>
      </div>
    </section>

    <!-- Informa√ß√µes financeiras -->
    <section class="card">
      <h2>Informa√ß√µes Financeiras</h2>
      <div class="grid cols-4">
        <div data-show="avista">
          <label>Valor √† vista</label>
          <input id="avista" placeholder="R$ 0,00" />
        </div>
        <div data-show="boleto">
          <label>Valor de entrada</label>
          <input id="entrada" placeholder="R$ 0,00" />
        </div>
        <div data-show="cartao,boleto">
          <label>N√∫mero de parcelas</label>
          <input id="nParcelas" placeholder="Ex.: 12" />
        </div>
        <div data-show="cartao,boleto">
          <label>Valor da parcela</label>
          <input id="parcela" placeholder="R$ 0,00" />
        </div>
      </div>

      <div class="grid cols-4" style="margin-top:16px">
        <div data-show="boleto">
          <label>Dia do vencimento</label>
          <input id="diaVenc" placeholder="5, 10, 15..." />
        </div>
        <div data-show="boleto">
          <label>Desconto aplicado</label>
          <input id="desconto" placeholder="R$ 0,00" />
        </div>
        <div>
          <label>Valor total do curso</label>
          <input id="total" placeholder="R$ 0,00" />
        </div>
      </div>
      
      <div class="hint" style="margin-top:12px">
        üí° <strong>Dica:</strong> Preencha pelo menos dois valores financeiros e o sistema calcular√° automaticamente os demais conforme a forma de pagamento escolhida.
      </div>
    </section>

    <!-- Sistema de Templates (vis√≠vel para o programa offline) -->
    <section class="card" id="sec-templates">
      <h2>üìã Sistema de Templates DOCX</h2>
      <div class="grid cols-2" style="margin-bottom: 12px;">
        <div>
          <label>Template de Contrato</label>
          <input type="file" id="templateUpload" accept=".docx" style="margin-bottom: 8px;" />
          <div class="hint">Envie um arquivo .docx com placeholders [CAMPO]</div>
        </div>
        <div style="display: flex; flex-direction: column; gap: 8px;">
          <button type="button" class="btn primary" id="btnPreencherTemplate" disabled>
            üìù Preencher Template
          </button>
          <button type="button" class="btn ghost" id="btnBaixarTemplate">
            üìÑ Baixar Template Exemplo
          </button>
          <button type="button" class="btn ghost" id="btnVerPlaceholders">
            üîç Ver Placeholders
          </button>
          <button type="button" class="btn warn" id="btnTestarBibliotecas" style="font-size: 12px;">
            üß™ Testar Bibliotecas
          </button>
        </div>
      </div>
      
      <div id="templateInfo" class="hint" style="display: none; background: rgba(91,157,255,0.1); padding: 12px; border-radius: 8px; margin-top: 12px;">
        <strong>Template carregado:</strong> <span id="templateNome"></span><br>
        <small>Pronto para preenchimento autom√°tico com os dados do formul√°rio</small>
      </div>
    </section>

    <!-- A√ß√µes dispon√≠veis -->
    <section class="card">
      <div class="actions">
        <button type="button" class="btn primary" id="btnDocx" title="Ctrl+D">
          üìù Gerar DOCX
        </button>
      </div>
      
      <hr style="border: none; border-top: 1px solid var(--border); margin: 16px 0" />
      
      <h3 style="margin: 0 0 12px; font-size: 16px; color: var(--muted);">üìä Hist√≥rico de Contratos</h3>
      <div class="actions" style="margin-top: 12px;">
        <button type="button" class="btn ghost" id="btnExportarHistorico" title="Exportar hist√≥rico completo">
          üìã Exportar Hist√≥rico XLSX
        </button>
        <button type="button" class="btn ghost" id="btnVerHistorico" title="Ver contratos salvos">
          üëÅÔ∏è Ver Hist√≥rico (<span id="contadorHistorico">0</span>)
        </button>
      </div>
      
      <div id="historicoInfo" class="hint" style="display: none; background: rgba(34,197,94,0.1); padding: 12px; border-radius: 8px; margin-top: 12px;">
        <strong>Hist√≥rico:</strong> <span id="historicoDetalhes"></span><br>
        <small>Os contratos s√£o salvos automaticamente ao gerar DOCX</small>
      </div>
    </section>
  </main>

  <footer>
    <div>
      <strong>Gerador de Contratos v2.2</strong> ‚Ä¢ 
      Desenvolvido com HTML5, CSS3 e JavaScript ‚Ä¢ 
      Exporta√ß√£o DOCX/JSON ‚Ä¢ 
      Sistema de c√°lculo autom√°tico ‚Ä¢ 
      Templates personaliz√°veis
    </div>
    <div style="margin-top: 8px; font-size: 11px; opacity: 0.8;">
      ‚å®Ô∏è Atalhos: Ctrl+D (DOCX) ‚Ä¢ F5 (Exemplo) ‚Ä¢ F9 (Recalcular)
    </div>
  </footer>

  <!-- Script para copiar dados do respons√°vel para o aluno -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const btnCopiarResp = document.getElementById('btnCopiarResp');
      
      if (btnCopiarResp) {
        btnCopiarResp.addEventListener('click', function() {
          // Mapear campos do respons√°vel para o aluno
          const mapeamento = {
            'nomeResp': 'nomeAluno',
            'nascResp': 'nascAluno',
            'cpfResp': 'cpfAluno',
            'rgResp': 'rgAluno'
          };
          
          let camposCopiados = 0;
          
          // Copiar campos preenchidos
          Object.keys(mapeamento).forEach(campoResp => {
            const elementoResp = document.getElementById(campoResp);
            const elementoAluno = document.getElementById(mapeamento[campoResp]);
            
            if (elementoResp && elementoAluno && elementoResp.value.trim()) {
              elementoAluno.value = elementoResp.value;
              camposCopiados++;
            }
          });
          
          // Feedback visual
          if (camposCopiados > 0) {
            btnCopiarResp.innerHTML = '‚úÖ Copiado!';
            btnCopiarResp.style.background = 'linear-gradient(180deg, #22c55e, #16a34a)';
            btnCopiarResp.style.color = 'white';
            
            setTimeout(() => {
              btnCopiarResp.innerHTML = 'üìã Copiar do Respons√°vel';
              btnCopiarResp.style.background = '';
              btnCopiarResp.style.color = '';
            }, 2000);
            
            console.log(`‚úÖ ${camposCopiados} campos copiados do respons√°vel para o aluno`);
          } else {
            btnCopiarResp.innerHTML = '‚ö†Ô∏è Nada para copiar';
            btnCopiarResp.style.background = 'linear-gradient(180deg, #eab308, #ca8a04)';
            btnCopiarResp.style.color = 'white';
            
            setTimeout(() => {
              btnCopiarResp.innerHTML = 'üìã Copiar do Respons√°vel';
              btnCopiarResp.style.background = '';
              btnCopiarResp.style.color = '';
            }, 2000);
            
            console.log('‚ö†Ô∏è Nenhum campo do respons√°vel preenchido para copiar');
          }
        });
      }
      
      // Formata√ß√£o autom√°tica do campo de carga hor√°ria
      const campoCarga = document.getElementById('carga');
      if (campoCarga) {
        campoCarga.addEventListener('blur', function() {
          let valor = this.value.trim();
          
          // Se o valor cont√©m apenas n√∫meros, adiciona "h"
          if (valor && /^\d+$/.test(valor)) {
            this.value = valor + 'h';
            console.log(`üìö Carga hor√°ria formatada: ${valor} ‚Üí ${valor}h`);
          }
        });
        
        // Tamb√©m formatar ao pressionar Enter
        campoCarga.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            let valor = this.value.trim();
            
            if (valor && /^\d+$/.test(valor)) {
              this.value = valor + 'h';
              console.log(`üìö Carga hor√°ria formatada: ${valor} ‚Üí ${valor}h`);
            }
            
            // Move o foco para o pr√≥ximo campo
            const proximoCampo = document.getElementById('contrato');
            if (proximoCampo) proximoCampo.focus();
          }
        });
      }
      
      // Sistema de Hist√≥rico de Contratos
      const STORAGE_KEY = 'gerador_historico_contratos';
      
      // Fun√ß√£o para obter todos os dados do formul√°rio
  window.obterDadosFormulario = function obterDadosFormulario() {
        const campos = [
          'modelo', 'forma', 'data', 'nomeResp', 'nascResp', 'cpfResp', 'rgResp', 'telResp',
          'endereco', 'numero', 'bairro', 'cep', 'cidadeUf', 'nomeAluno', 'nascAluno', 
          'sexoAluno', 'rgAluno', 'cpfAluno', 'raAluno', 'curso', 'carga', 'contrato',
          'avista', 'entrada', 'nParcelas', 'parcela', 'diaVenc', 'desconto', 'total'
        ];
        
        const dados = {};
        campos.forEach(campo => {
          const elemento = document.getElementById(campo);
          if (elemento) {
            dados[campo] = elemento.value || '';
          }
        });
        
        // Adiciona timestamp e ID √∫nico
        dados._timestamp = new Date().toISOString();
        dados._id = Date.now().toString(36) + Math.random().toString(36).substr(2);
        dados._dataFormatada = new Date().toLocaleString('pt-BR');
        
        return dados;
  }
      
      // Fun√ß√£o para salvar contrato no hist√≥rico (exposta no escopo global)
      window.salvarContratoNoHistorico = function salvarContratoNoHistorico() {
        try {
          const dadosContrato = (window.obterDadosFormulario && window.obterDadosFormulario());
          if (!dadosContrato) throw new Error('obterDadosFormulario indispon√≠vel');
          
          // Obt√©m hist√≥rico existente
          let historico = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
          
          // Adiciona novo contrato
          historico.push(dadosContrato);
          
          // Limita a 100 contratos (evita ocupar muito espa√ßo)
          if (historico.length > 100) {
            historico = historico.slice(-100);
          }
          
          // Salva de volta no localStorage
          localStorage.setItem(STORAGE_KEY, JSON.stringify(historico));
          
          // Atualiza contador na interface
          window.atualizarContadorHistorico && window.atualizarContadorHistorico();
          
          console.log('‚úÖ Contrato salvo no hist√≥rico:', dadosContrato.contrato || dadosContrato._id);
          
          // Mostra feedback visual
          window.mostrarFeedbackHistorico && window.mostrarFeedbackHistorico(`Contrato ${dadosContrato.contrato || 'sem n√∫mero'} salvo no hist√≥rico!`);
          
        } catch (error) {
          console.error('‚ùå Erro ao salvar contrato no hist√≥rico:', error);
        }
      }
      
      // Fun√ß√£o para atualizar contador na interface
  window.atualizarContadorHistorico = function atualizarContadorHistorico() {
        try {
          const historico = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
          const contador = document.getElementById('contadorHistorico');
          if (contador) {
            contador.textContent = historico.length;
          }
        } catch (error) {
          console.error('‚ùå Erro ao atualizar contador:', error);
        }
  }
      
      // Fun√ß√£o para mostrar feedback visual
  window.mostrarFeedbackHistorico = function mostrarFeedbackHistorico(mensagem) {
        const info = document.getElementById('historicoInfo');
        const detalhes = document.getElementById('historicoDetalhes');
        
        if (info && detalhes) {
          detalhes.textContent = mensagem;
          info.style.display = 'block';
          
          setTimeout(() => {
            info.style.display = 'none';
          }, 3000);
        }
  }
      
      // Fun√ß√£o para exportar hist√≥rico para XLSX
  window.exportarHistoricoXLSX = function exportarHistoricoXLSX() {
        try {
          const historico = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
          
          if (historico.length === 0) {
            alert('‚ö†Ô∏è Nenhum contrato no hist√≥rico para exportar.');
            return;
          }
          
          // Prepara dados para XLSX
          const dadosExport = historico.map(contrato => ({
            'Data/Hora': contrato._dataFormatada,
            'N√∫mero Contrato': contrato.contrato,
            'Modelo': contrato.modelo,
            'Forma Pagamento': contrato.forma,
            'Data Contrato': contrato.data,
            'Nome Respons√°vel': contrato.nomeResp,
            'CPF Respons√°vel': contrato.cpfResp,
            'Telefone Respons√°vel': contrato.telResp,
            'Endere√ßo': contrato.endereco,
            'N√∫mero': contrato.numero,
            'Bairro': contrato.bairro,
            'CEP': contrato.cep,
            'Cidade/UF': contrato.cidadeUf,
            'Nome Aluno': contrato.nomeAluno,
            'Nasc. Aluno': contrato.nascAluno,
            'Sexo Aluno': contrato.sexoAluno,
            'CPF Aluno': contrato.cpfAluno,
            'RA Aluno': contrato.raAluno,
            'Curso': contrato.curso,
            'Carga Hor√°ria': contrato.carga,
            'Valor √Ä Vista': contrato.avista,
            'Valor Entrada': contrato.entrada,
            'N¬∫ Parcelas': contrato.nParcelas,
            'Valor Parcela': contrato.parcela,
            'Dia Vencimento': contrato.diaVenc,
            'Desconto': contrato.desconto,
            'Valor Total': contrato.total
          }));
          
          // Cria workbook e worksheet
          const wb = XLSX.utils.book_new();
          const ws = XLSX.utils.json_to_sheet(dadosExport);
          
          // Ajusta largura das colunas
          const colWidths = [
            {wch: 20}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 12},
            {wch: 25}, {wch: 15}, {wch: 15}, {wch: 30}, {wch: 8},
            {wch: 20}, {wch: 12}, {wch: 15}, {wch: 25}, {wch: 12},
            {wch: 10}, {wch: 15}, {wch: 12}, {wch: 25}, {wch: 12},
            {wch: 12}, {wch: 12}, {wch: 10}, {wch: 12}, {wch: 10},
            {wch: 12}, {wch: 12}
          ];
          ws['!cols'] = colWidths;
          
          // Adiciona worksheet ao workbook
          XLSX.utils.book_append_sheet(wb, ws, 'Hist√≥rico Contratos');
          
          // Gera nome do arquivo com data atual
          const agora = new Date();
          const dataArquivo = agora.toISOString().split('T')[0];
          const nomeArquivo = `Historico_Contratos_${dataArquivo}.xlsx`;
          
          // Faz download
          XLSX.writeFile(wb, nomeArquivo);
          
          console.log(`üìä Hist√≥rico exportado: ${nomeArquivo} (${historico.length} contratos)`);
          window.mostrarFeedbackHistorico && window.mostrarFeedbackHistorico(`${historico.length} contratos exportados para ${nomeArquivo}`);
          
        } catch (error) {
          console.error('‚ùå Erro ao exportar hist√≥rico:', error);
          alert('‚ùå Erro ao exportar hist√≥rico. Verifique o console para detalhes.');
        }
  }
      
      // Event Listeners para os bot√µes de hist√≥rico
      const btnExportarHistorico = document.getElementById('btnExportarHistorico');
      if (btnExportarHistorico) {
        btnExportarHistorico.addEventListener('click', () => window.exportarHistoricoXLSX && window.exportarHistoricoXLSX());
      }
      
      const btnVerHistorico = document.getElementById('btnVerHistorico');
      if (btnVerHistorico) {
        btnVerHistorico.addEventListener('click', function() {
          try {
            const historico = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            
            if (historico.length === 0) {
              alert('üìã Nenhum contrato no hist√≥rico ainda.');
              return;
            }
            
            // Mostra os √∫ltimos 10 contratos
            const ultimos = historico.slice(-10).reverse();
            let mensagem = `üìä √öltimos ${ultimos.length} contratos:\n\n`;
            
            ultimos.forEach((contrato, index) => {
              mensagem += `${index + 1}. ${contrato.contrato || 'S/N'} - ${contrato.nomeAluno || 'S/N'} - ${contrato._dataFormatada}\n`;
            });
            
            mensagem += `\nüíæ Total: ${historico.length} contratos salvos`;
            alert(mensagem);
            
          } catch (error) {
            console.error('‚ùå Erro ao visualizar hist√≥rico:', error);
          }
        });
      }
      
      // Hook n√£o-destrutivo ser√° adicionado no script final da p√°gina
      
      // Inicializa contador ao carregar a p√°gina
      window.atualizarContadorHistorico && window.atualizarContadorHistorico();
    });
  </script>

  <!-- Modal de relat√≥rio t√©cnico do download DOCX -->
  <div id="relatorio-modal" aria-hidden="true">
    <div id="relatorio-backdrop"></div>
    <div id="relatorio-card" role="dialog" aria-modal="true" aria-labelledby="relatorio-title">
      <div id="relatorio-header">
        <div id="relatorio-title">Relat√≥rio T√©cnico ‚Äî Fluxo de Download do DOCX</div>
        <button id="relatorio-close" class="btn-rel">‚úï</button>
      </div>
      <div id="relatorio-body">
        <pre id="relatorio-pre">Gerando‚Ä¶</pre>
      </div>
      <div id="relatorio-actions">
        <button id="relatorio-save-txt" class="btn-rel">Baixar .txt</button>
        <button id="relatorio-save-json" class="btn-rel">Baixar .json</button>
        <button id="relatorio-ok" class="btn-rel primary">Fechar</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    // --- elementos do modal
    const $ = (sel)=>document.querySelector(sel);
    const modal = $('#relatorio-modal');
    const pre   = $('#relatorio-pre');

    const state = {
      t: {}, // timestamps
      campos: {}, // snapshot dos campos
      gen: null,  // info de gera√ß√£o {filename, size}
      dwn: null   // info de download {filename}
    };

    function ts(){ return new Date().toISOString(); }
    function ms(d1,d2){ return Math.max(0, Math.round((d2-d1))); }

    // coleta r√°pida dos campos importantes (n√£o altera nada)
    function coletarCampos(){
      const get = id => document.getElementById(id)?.value || '';
      return {
        modelo: get('modelo'),
        forma: get('forma'),
        dataContrato: get('data'),
        responsavel: get('nomeResp'),
        aluno: get('nomeAluno'),
        curso: get('curso'),
        valorTotal: get('total'),
        template: document.getElementById('templateUpload')?.files?.[0]?.name || '(nenhum)'
      };
    }

    // abre/fecha modal
    function abrir(texto) {
      pre.textContent = texto || '';
      modal.classList.add('show');
      modal.setAttribute('aria-hidden','false');
    }
    function fechar() {
      modal.classList.remove('show');
      modal.setAttribute('aria-hidden','true');
    }

    // monta relat√≥rio t√©cnico
    function montarRelatorio(){
      const ua = navigator.userAgent;
      const libs = {
        docx: !!(window.docx && window.docx.Packer && window.docx.Document),
        PizZip: !!window.PizZip,
        Docxtemplater: !!(window.Docxtemplater || window.docxtemplater)
      };

      const t0 = state.t.clique || 0;
      const t1 = state.t.dispatch || t0;
      const t2 = state.t.gerado   || t1;
      const t3 = state.t.download || t2;

      const resumo = [
        'Relat√≥rio T√©cnico: Fluxo de Download do DOCX',
        `In√≠cio: ${new Date(t0).toLocaleString()}  |  T√©rmino: ${new Date(t3).toLocaleString()}`,
        '',
        '1) Gatilho do Download',
        '‚Ä¢ Bot√£o üìù Gerar DOCX (#btnDocx) clicado pelo usu√°rio.',
        '‚Ä¢ Salvamento no hist√≥rico executado pelo handler do bot√£o.',
        "‚Ä¢ Evento customizado disparado: window.dispatchEvent(new CustomEvent('gerarDocx')).",
        '',
        '2) Implementa√ß√£o do Download',
        '‚Ä¢ Template processado e DOCX gerado com Docxtemplater/PizZip.',
        '‚Ä¢ Blob ‚Üí URL tempor√°ria via URL.createObjectURL(blob).',
        '‚Ä¢ <a download> criado dinamicamente e clique simulado.',
        '‚Ä¢ URL revogada ap√≥s o oferecimento do download.',
        '',
        '3) Registro e Diagn√≥stico',
        '‚Ä¢ Evento docx:generated e docx:downloaded observados para auditoria.',
        '‚Ä¢ Este relat√≥rio foi mostrado automaticamente ao download.',
        '',
        '4) Pontos de Aten√ß√£o',
        '‚Ä¢ Download autom√°tico (sem intera√ß√£o extra ap√≥s o clique).',
        '‚Ä¢ Nome do arquivo: ' + (state.gen?.filename || state.dwn?.filename || '(desconhecido)'),
        '',
        '--- Cronologia (ms) ---',
        `Clique (#btnDocx):      ${new Date(t0).toLocaleTimeString()} (T0)`,
        `Dispatch 'gerarDocx':   ${new Date(t1).toLocaleTimeString()}  +${ms(t0,t1)}ms`,
        `DOCX gerado:            ${new Date(t2).toLocaleTimeString()}  +${ms(t1,t2)}ms`,
        `Download ofertado:      ${new Date(t3).toLocaleTimeString()}  +${ms(t2,t3)}ms`,
        `Total do fluxo:         ${ms(t0,t3)}ms`,
        '',
        '--- Ambiente ---',
        `Bibliotecas: ${JSON.stringify(libs)}`,
        `Navegador: ${ua}`,
        '',
        '--- Campos do Formul√°rio ---',
        JSON.stringify(state.campos, null, 2),
        '',
        '--- Arquivo ---',
        `Gerado: ${state.gen ? 'sim' : 'n√£o'}`,
        state.gen ? `‚Ä¢ Nome: ${state.gen.filename}\n‚Ä¢ Tamanho: ${state.gen.size} bytes` : '',
      ].join('\n');

      return resumo;
    }

    // a√ß√µes dos bot√µes do modal
    $('#relatorio-close').addEventListener('click', fechar);
    $('#relatorio-ok').addEventListener('click', fechar);
    $('#relatorio-save-txt').addEventListener('click', () => {
      const blob = new Blob([pre.textContent], {type:'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a');
      a.href = url; a.download = 'relatorio_exportacao.txt'; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url), 500);
    });
    $('#relatorio-save-json').addEventListener('click', () => {
      const json = {
        timeline: state.t,
        campos: state.campos,
        generated: state.gen,
        downloaded: state.dwn,
        libs: { docx: !!(window.docx && window.docx.Packer && window.docx.Document), PizZip: !!window.PizZip, Docxtemplater: !!(window.Docxtemplater || window.docxtemplater) },
        ua: navigator.userAgent
      };
      const blob = new Blob([JSON.stringify(json,null,2)], {type:'application/json;charset=utf-8'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a');
      a.href = url; a.download = 'relatorio_exportacao.json'; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url), 500);
    });

    // --- timeline: capturas discretas do fluxo (sem interferir no seu c√≥digo)
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('btnDocx');
      if (btn) {
        btn.addEventListener('click', () => {
          state.t.clique = Date.now();
          state.campos = coletarCampos();
        }, { capture: true });
      }
    });

    window.addEventListener('gerarDocx', () => { state.t.dispatch = Date.now(); }, { capture: true });
    window.addEventListener('docx:generated', (e) => {
      state.t.gerado = Date.now();
      state.gen = e.detail || null;
    }, { capture: true });

    // Quando o download √© ofertado: monta e abre o popup
    window.addEventListener('docx:downloaded', (e) => {
      state.t.download = Date.now();
      state.dwn = e.detail || null;
      const texto = montarRelatorio();
      abrir(texto);
    }, { capture: true });
  })();
  </script>
<script>
/* Hook passivo para detectar gera√ß√£o/baixar DOCX */
(function () {
  if (window.__docxDownloadHookInstalled) return;
  window.__docxDownloadHookInstalled = true;

  console.log('[Hook] Sistema de intercepta√ß√£o de download instalado');

  // Intercepta clique em links de download .docx
  document.addEventListener('click', function(e) {
    const target = e.target.closest('a');
    if (target && target.getAttribute('download') && 
        target.getAttribute('download').toLowerCase().endsWith('.docx')) {
      
      const filename = target.getAttribute('download');
      console.log('[Hook] Download DOCX detectado:', filename);
      
      // Dispara evento de download
      setTimeout(() => {
        window.dispatchEvent(new CustomEvent('docx:downloaded', {
          detail: { filename }
        }));
      }, 100);
    }
  }, true);
})();
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const btnDocx = document.getElementById('btnDocx');
  if (!btnDocx) return;

  // captura: roda antes dos outros handlers SEM remover ningu√©m
  btnDocx.addEventListener('click', function () {
    try { window.salvarContratoNoHistorico && window.salvarContratoNoHistorico(); } catch (e) { console.warn(e); }
    // deixa os demais listeners fazerem a gera√ß√£o
  }, true);
});
</script>

  <!-- ‚úÖ Popup visual de download conclu√≠do -->
  <script>
  (function() {
    // cria e estiliza o popup (uma vez s√≥)
    const toast = document.createElement('div');
    toast.id = 'popup-download';
    Object.assign(toast.style, {
      position: 'fixed',
      right: '20px',
      bottom: '20px',
      background: 'linear-gradient(180deg,#22c55e,#16a34a)',
      color: '#fff',
      padding: '14px 18px',
      borderRadius: '12px',
      boxShadow: '0 8px 24px rgba(0,0,0,0.25)',
      fontFamily: 'system-ui, sans-serif',
      fontSize: '14px',
      lineHeight: '1.4',
      opacity: '0',
      transform: 'translateY(10px)',
      transition: 'opacity .3s, transform .3s',
      zIndex: '9999'
    });
    document.body.appendChild(toast);

    // logs para checar que carregou
    console.log('[Popup] Listener ativo');

    // mostra a mensagem por alguns segundos
    function showPopup(msg) {
      toast.textContent = msg;
      toast.style.opacity = '1';
      toast.style.transform = 'translateY(0)';
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(10px)';
      }, 4000);
    }

    // Flag para saber se o download foi disparado por atalho
    let downloadPorAtalho = false;

    // Detecta Ctrl+D
    document.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && (e.key === 'd' || e.key === 'D')) {
        downloadPorAtalho = true;
        setTimeout(() => { downloadPorAtalho = false; }, 2000); // reseta ap√≥s 2s
      }
    });

    // escuta o evento de download j√° emitido pelo exports.js
    window.addEventListener('docx:downloaded', (e) => {
      if (downloadPorAtalho) {
        const filename = e.detail?.filename || 'Contrato_preenchido.docx';
        showPopup(`‚úÖ Download conclu√≠do!\n${filename}`);
      }
    });

    // opcional: tamb√©m exibir quando o DOCX for gerado internamente
    window.addEventListener('docx:generated', (e) => {
      if (downloadPorAtalho) {
        const filename = e.detail?.filename || 'Contrato.docx';
        showPopup(`üìÑ Documento gerado: ${filename}`);
      }
    });
  })();
  </script>
</body>
<!-- Removido </html> duplicado -->
 </html>